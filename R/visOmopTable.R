#' Format a summarised_result object into a gt, flextable, or tibble object.
#'
#' @param result A `summarised_result` object.
#' @param formatEstimateName A named list of estimate names to join, sorted by
#' computation order. Use `<...>` to indicate estimate names.
#' @param header A vector specifying the elements to include in the header.
#' The order of elements matters, with the first being the topmost header.
#' The input vector elements can be:
#' 1) Column names from the split summarised result generated by `splitAll()`
#' 2) Settings specified in the `settingsColumns` argument
#' 3) `group`, `strata`, `additional`, `variable`, `estimate`, and/or `settings`
#'    to refer to all columns within these groups
#' 4) Any other input to create overall header labels at the specified location.
#' @param settingsColumns A character vector with the names of settings to
#' include in the table.
#' @param groupColumn Columns to use as group labels. By default, the name of the
#' new group will be the tidy* column names separated by ";". To specify a custom
#' group name, use a named list such as:
#' list("newGroupName" = c("variable_name", "variable_level")).
#'
#' *tidy: The tidy format applied to column names replaces "_" with a space and
#' converts to sentence case. Use `renameColumns` to customize specific column names.
#'
#' @param renameColumns A named vector to customize column names, e.g.,
#' c("Database name" = "cdm_name"). The function renames all column names
#' not specified here into a tidy* format.
#' @param type The type of desired formatted table. Options are: "gt",
#' "flextable", or "tibble".
#' @param hide Columns to drop from the output table. By default, `result_id` and
#' `estimate_type` are always dropped.
#' @param showMinCellCount If `TRUE`, suppressed estimates will be indicated with
#' "<\{min_cell_count\}", otherwise, the default `na` defined in `.options` will be
#' used.
#' @param .options A named list with additional formatting options.
#' `visOmopResults::optionsTable()` shows allowed arguments and their default values.
#' @param minCellCount `r lifecycle::badge("deprecated")`
#' @param split `r lifecycle::badge("deprecated")`
#'
#' @return A tibble, gt, or flextable object.
#'
#' @description
#' This function combines the functionalities of `formatEstimateValue()`,
#' `formatEstimateName()`, `formatHeader()`, `gtTable()`, and `fxTable()`
#' into a single function specifically for `summarised_result` objects.
#'
#' @export
#'
#' @examples
#' result <- mockSummarisedResult()
#' result |>
#'   visOmopTable(
#'     formatEstimateName = c("N%" = "<count> (<percentage>)",
#'                            "N" = "<count>",
#'                            "Mean (SD)" = "<mean> (<sd>)"),
#'     header = c("group"),
#'     renameColumns = c("Database name" = "cdm_name"),
#'     groupColumn = strataColumns(result)
#'   )

visOmopTable <- function(result,
                         formatEstimateName = character(),
                         header = character(),
                         settingsColumns = character(),
                         groupColumn = character(),
                         renameColumns = character(),
                         type = "gt",
                         hide = character(),
                         showMinCellCount = TRUE,
                         .options = list(),
                         split = lifecycle::deprecated(),
                         minCellCount = lifecycle::deprecated()) {

  if (lifecycle::is_present(minCellCount)) {
    lifecycle::deprecate_stop("0.3.0", "visOmopTable(minCellCount)")
  }
  if (lifecycle::is_present(split)) {
    lifecycle::deprecate_warn("0.4.0", "visOmopTable(split)")
  }

  # Tidy results
  result <- omopgenerics::validateResultArguemnt(result)
  resultTidy <- tidySummarisedResult(result, settingsColumns = settingsColumns, pivotEstimatesBy = NULL)

  # .options
  .options <- defaultTableOptions(.options)

  # Backward compatibility ---> to be deleted in the future
  omopgenerics::assertCharacter(header, null = TRUE)
  omopgenerics::assertCharacter(hide, null = TRUE)
  settingsColumns <- validateSettingsColumns(settingsColumns, result) # to remove > 0.4.0
  bc <- backwardCompatibility(header, hide, result, settingsColumns) # to remove > 0.4.0
  header <- bc$header # to remove > 0.4.0
  hide <- bc$hide # to remove > 0.4.0
  if ("variable_level" %in% header) {
    resultTidy <- resultTidy |>
      dplyr::mutate(dplyr::across(dplyr::starts_with("variable"), ~ dplyr::if_else(is.na(.x), .options$na, .x)))
  }

  # initial checks and preparation
  renameColumns <- validateRenameColumns(renameColumns, result)
  if (!"cdm_name" %in% renameColumns) renameColumns <- c(renameColumns, "CDM name" = "cdm_name")
  groupColumn <- validateGroupColumn(groupColumn, resultTidy, sr = TRUE, formatName = TRUE)
  showMinCellCount <- validateShowMinCellCount(showMinCellCount, settings(result))
  # default SR hide columns
  hide <- c(hide, "result_id", "estimate_type") |> unique()
  checkVisTableInputs(header, groupColumn, hide)

  # showMinCellCount
  if (showMinCellCount) {
    if ("min_cell_count" %in% settingsColumns) {
      resultTidy <- resultTidy |>
        dplyr::mutate(estimate_value = dplyr::if_else(
          is.na(.data$estimate_value), paste0("<", base::format(.data$min_cell_count, big.mark = ",")), .data$estimate_value
        ))
    } else {
      resultTidy <- resultTidy |>
        dplyr::left_join(
          settings(result) |> dplyr::select("result_id", "min_cell_count"),
          by = "result_id"
        ) |>
        dplyr::mutate(estimate_value = dplyr::if_else(
          is.na(.data$estimate_value), paste0("<", base::format(.data$min_cell_count, big.mark = ",")), .data$estimate_value
        )) |>
        dplyr::select(!"min_cell_count")
    }
  }

  tableOut <- visTable(
    result = resultTidy,
    formatEstimateName = formatEstimateName,
    header = header,
    groupColumn = groupColumn,
    type = type,
    renameColumns = renameColumns,
    hide = hide,
    .options = .options
  )

  return(tableOut)
}

formatToSentence <- function(x) {
  stringr::str_to_sentence(gsub("_", " ", gsub("&&&", "and", x)))
}

defaultTableOptions <- function(userOptions) {
  defaultOpts <- list(
    decimals = c(integer = 0, percentage = 2, numeric = 2, proportion = 2),
    decimalMark = ".",
    bigMark = ",",
    keepNotFormatted = TRUE,
    useFormatOrder = TRUE,
    delim = "\n",
    includeHeaderName = TRUE,
    includeHeaderKey = TRUE,
    style = "default",
    na = "-",
    title = NULL,
    subtitle = NULL,
    caption = NULL,
    groupAsColumn = FALSE,
    groupOrder = NULL,
    colsToMergeRows = "all_columns"
  )

  for (opt in names(userOptions)) {
    defaultOpts[[opt]] <- userOptions[[opt]]
  }

  return(defaultOpts)
}

#' Additional arguments for the function visOmopTable
#'
#' @description
#' It provides a list of allowed inputs for .option argument in
#' visOmopTable and their given default value.
#'
#'
#' @return The default .options named list.
#'
#' @export
#'
#' @examples
#' {
#' optionsTable()
#' }
#'
#'
optionsTable <- function() {
  return(defaultTableOptions(NULL))
}

backwardCompatibility <- function(header, hide, result, settingsColumns) {

  if (all(is.na(result$variable_level)) & "variable" %in% header) {
    colsVariable <- c("variable_name")
    hide <- c(hide, "variable_level")
  } else {
    colsVariable <- c("variable_name", "variable_level")
  }

  header <- purrr::map(header, function(x) {
    switch(x,
           cdm_name = "cdm_name",
           group = groupColumns(result),
           strata = strataColumns(result),
           additional = additionalColumns(result),
           variable = colsVariable,
           estimate = c("estimate_name"),
           settings = settingsColumns)
  }) |> unlist()

  return(list(hide = hide, header = header))
}
